<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Sock Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg:#f5f6fa; --card:#ffffff; --text:#222; --muted:#666; --primary:#5b7cfa; --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#e5e7eb;
  }
  .dark {
    --bg:#101114; --card:#17181c; --text:#e5e7eb; --muted:#9aa0a6; --primary:#7aa2ff; --ok:#29d17d; --warn:#ffd166; --bad:#ff6b6b; --border:#2a2c33;
  }
  * { box-sizing: border-box }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
  header { position:sticky; top:0; z-index:5; display:flex; gap:.75rem; align-items:center; justify-content:space-between; padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border); }
  header h1 { margin:0; font-size:1.1rem; font-weight:700; display:flex; align-items:center; gap:.5rem }
  .pill { padding:4px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--border); color:var(--muted); }
  .row { display:flex; flex-wrap:wrap; gap:16px; padding:16px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; flex:1 1 280px; min-width:260px; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
  .card h2 { margin:0 0 8px 0; font-size:1rem }
  .value { font-size:2.15rem; font-weight:700; letter-spacing:.3px }
  .sub { color:var(--muted); font-size:.9rem }
  .btn { border:1px solid var(--border); background:var(--card); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; }
  .btn.primary { background:var(--primary); border-color:transparent; color:white; }
  .btn.warning { background:var(--warn); border-color:transparent; color:#222; }
  .btn.ghost { background:transparent; }
  .actions { display:flex; gap:8px; flex-wrap:wrap }
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; padding:0 16px 16px; }
  canvas { width:100%; height:220px; background:#0f1117; border-radius:10px; }
  .ok { color:var(--ok) } .warn { color:var(--warn) } .bad { color:var(--bad) }
  dialog { border:none; border-radius:16px; padding:0; width:min(720px, 95vw); background:var(--card); color:var(--text); }
  .dlg-head { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border) }
  .dlg-body { padding:16px; display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); }
  .field { display:flex; flex-direction:column; gap:6px }
  .field label { font-size:.85rem; color:var(--muted) }
  .field input, .field select, .field textarea { background:transparent; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; }
  .foot { display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid var(--border) }
  .muted { color:var(--muted) }
  .list { display:flex; flex-wrap:wrap; gap:8px; }
  .chip { font-size:.85rem; border:1px solid var(--border); background:var(--card); padding:6px 8px; border-radius:999px; }
  .inline { display:flex; align-items:center; gap:10px }
  .status-dot { width:10px; height:10px; border-radius:50%; background:var(--bad); }
  .status-dot.ok { background:var(--ok) }
  .status-dot.warn { background:var(--warn) }
  .heatmap { width:100%; aspect-ratio:1/1; background:#0f1117; border-radius:10px; display:block }
  a { color:var(--primary); text-decoration:none }
</style>
</head>
<body>
<header>
  <h1>ðŸ§¦ Smart Sock Dashboard <span id="ver" class="pill">v1.0</span></h1>
  <div class="actions">
    <button id="connectBtn" class="btn primary">Connect ESP32 (BLE)</button>
    <button id="settingsBtn" class="btn">Settings</button>
    <button id="exportBtn" class="btn">Export CSV</button>
    <button id="themeBtn" class="btn">Toggle Theme</button>
  </div>
</header>

<!-- Top stats -->
<div class="row" id="statsRow">
  <div class="card" id="tempCard">
    <h2>Temperature</h2>
    <div class="value" id="tempVal">--</div>
    <div class="sub" id="tempSub">â€”</div>
  </div>
  <div class="card" id="humCard">
    <h2>Humidity</h2>
    <div class="value" id="humVal">--</div>
    <div class="sub" id="humSub">â€”</div>
  </div>
  <div class="card" id="pressCard">
    <h2>Pressure</h2>
    <div class="value" id="pressVal">--</div>
    <div class="sub" id="pressSub">â€”</div>
  </div>
  <div class="card">
    <h2>Connection</h2>
    <div class="inline">
      <span id="connDot" class="status-dot"></span>
      <span id="connTxt" class="sub">Disconnected</span>
    </div>
    <div class="sub" style="margin-top:8px">Device: <span id="devName" class="muted">â€”</span></div>
  </div>
</div>

<!-- Charts & Heatmap -->
<div class="grid">
  <div class="card">
    <h2>Temperature Trend (Â°C)</h2>
    <canvas id="tempChart"></canvas>
  </div>
  <div class="card">
    <h2>Humidity Trend (%)</h2>
    <canvas id="humChart"></canvas>
  </div>
  <div class="card">
    <h2>Pressure Trend (avg)</h2>
    <canvas id="pressChart"></canvas>
  </div>
  <div class="card">
    <h2>Pressure Heatmap</h2>
    <canvas id="heatmap" class="heatmap"></canvas>
    <div class="sub" id="heatmapLegend" style="margin-top:8px">Auto-grid based on sensor count</div>
    <div class="list" id="sensorChips" style="margin-top:8px"></div>
  </div>
</div>

<!-- Settings dialog -->
<dialog id="settingsDlg">
  <div class="dlg-head">
    <strong>Dashboard Settings</strong>
    <button class="btn ghost" id="closeSettings">âœ•</button>
  </div>
  <div class="dlg-body">
    <div class="field"><label>BLE Service UUID</label><input id="svcUuid"></div>
    <div class="field"><label>BLE Characteristic UUID</label><input id="chrUuid"></div>
    <div class="field"><label>High Temp Alert (Â°C)</label><input id="thTemp" type="number" step="0.1"></div>
    <div class="field"><label>High Pressure Alert</label><input id="thPress" type="number"></div>
    <div class="field"><label>Rolling History (points)</label><input id="histLen" type="number" min="30" max="2000"></div>
    <div class="field">
      <label>Sensor Names (comma separated for pressure sensors)</label>
      <input id="sensorNames" placeholder="Heel, Arch, Ball, Big Toe, ...">
    </div>
    <div class="field">
      <label>Data Format</label>
      <select id="fmt">
        <option value="auto">Auto (detect JSON or legacy string)</option>
        <option value="string">Legacy string (T:.. H:.. P:.. ..)</option>
        <option value="json">JSON {"T":..,"H":..,"P":[...]}</option>
      </select>
    </div>
    <div class="field" style="grid-column:1/-1">
      <label>Notes</label>
      <textarea rows="3" placeholder="Optional project notes..." id="notes"></textarea>
    </div>
  </div>
  <div class="foot">
    <button class="btn" id="resetBtn">Reset Defaults</button>
    <button class="btn primary" id="saveBtn">Save</button>
  </div>
</dialog>

<script>
/* ------------------ Config & State ------------------ */
const DEFAULTS = {
  svcUuid: '12345678-1234-1234-1234-123456789abc',
  chrUuid: 'abcdefab-1234-1234-1234-abcdefabcdef',
  thTemp: 38.0,
  thPress: 800,
  histLen: 300,
  fmt: 'auto',
  theme: (localStorage.getItem('theme') || 'light'),
  sensorNames: []
};

let cfg = loadCfg();
applyTheme(cfg.theme);

const state = {
  connected: false,
  deviceName: 'â€”',
  last: { T: null, H: null, P: [] },
  labels: [],
  tempHist: [],
  humHist: [],
  pressAvgHist: [],
  pressHistAll: [], // array of arrays [p1[],p2[],...]
};

/* ------------------ UI Elements ------------------ */
const el = (id)=>document.getElementById(id);
const connDot = el('connDot'); const connTxt = el('connTxt'); const devName = el('devName');
const tempVal = el('tempVal'); const tempSub = el('tempSub');
const humVal = el('humVal'); const humSub = el('humSub');
const pressVal = el('pressVal'); const pressSub = el('pressSub');
const heatmapCanvas = el('heatmap'); const chips = el('sensorChips');

/* ------------------ Charts ------------------ */
const tempChart = new Chart(el('tempChart').getContext('2d'), {
  type:'line',
  data:{ labels: state.labels, datasets:[{ label:'Â°C', data: state.tempHist, fill:false, tension:.25 }]},
  options:{ animation:false, responsive:true, scales:{ x:{ display:false } } }
});
const humChart = new Chart(el('humChart').getContext('2d'), {
  type:'line',
  data:{ labels: state.labels, datasets:[{ label:'%RH', data: state.humHist, fill:false, tension:.25 }]},
  options:{ animation:false, responsive:true, scales:{ x:{ display:false }, y:{ min:0, max:100 } } }
});
const pressChart = new Chart(el('pressChart').getContext('2d'), {
  type:'line',
  data:{ labels: state.labels, datasets:[{ label:'Avg Pressure', data: state.pressAvgHist, fill:false, tension:.25 }]},
  options:{ animation:false, responsive:true, scales:{ x:{ display:false } } }
});

/* ------------------ Heatmap Drawing ------------------ */
function drawHeatmap(values) {
  const ctx = heatmapCanvas.getContext('2d');
  const n = values.length || 1;
  const cols = Math.ceil(Math.sqrt(n)); // auto grid
  const rows = Math.ceil(n / cols);
  const w = heatmapCanvas.width = heatmapCanvas.clientWidth * devicePixelRatio;
  const h = heatmapCanvas.height = heatmapCanvas.clientWidth * devicePixelRatio; // keep square
  const cw = Math.floor(w / cols); const ch = Math.floor(h / rows);
  const max = Math.max(1, ...values);
  ctx.clearRect(0,0,w,h);
  for (let i=0;i<n;i++){
    const r = Math.floor(i/cols), c = i%cols;
    const v = values[i] || 0;
    const t = v / max; // 0..1
    // gradient: blue -> green -> yellow -> red
    const color = heatColor(t);
    ctx.fillStyle = color;
    ctx.fillRect(c*cw, r*ch, cw-2, ch-2);
  }
}
function heatColor(t){ // t in [0,1]
  const r = Math.floor(255*Math.max(0, Math.min(1, (t*2-0.0))));
  const g = Math.floor(255*Math.max(0, Math.min(1, (1 - Math.abs(t*2-1)))));
  const b = Math.floor(255*Math.max(0, Math.min(1, (1 - t)*2)));
  return `rgb(${r},${g},${b})`;
}

/* ------------------ Parsing (String or JSON) ------------------ */
function parsePayload(raw, fmt=cfg.fmt){
  try{
    if(fmt==='json' || (fmt==='auto' && raw.trim().startsWith('{'))){
      const obj = JSON.parse(raw);
      return { T: num(obj.T), H: num(obj.H), P: (obj.P||[]).map(num) };
    } else {
      // legacy string e.g. "T:36.5C H:45.2% P:102 204 150"
      const T = (raw.match(/T:([0-9.+-]+)/)||[])[1];
      const H = (raw.match(/H:([0-9.+-]+)/)||[])[1];
      const pStr = (raw.match(/P:([0-9 .-]+)/)||[])[1] || '';
      const P = pStr.trim().split(/\s+/).filter(Boolean).map(v=>parseInt(v,10)).filter(v=>!Number.isNaN(v));
      return { T: num(T), H: num(H), P };
    }
  } catch(e){
    console.warn('Parse error', e, raw);
    return { T:null,H:null,P:[] };
  }
}
const num = (v)=> v==null? null : (typeof v==='number'? v : parseFloat(String(v)));

/* ------------------ Data Flow ------------------ */
function pushData(sample){
  const ts = new Date().toISOString();
  state.labels.push(ts);
  if(sample.T!=null){ state.last.T = sample.T; state.tempHist.push(sample.T); }
  if(sample.H!=null){ state.last.H = sample.H; state.humHist.push(sample.H); }
  state.last.P = sample.P||[];
  const avgP = state.last.P.length ? Math.round(state.last.P.reduce((a,b)=>a+b,0)/state.last.P.length) : null;
  state.pressAvgHist.push(avgP);

  // keep history length
  const L = Math.max(30, cfg.histLen|0);
  for (const arr of [state.labels, state.tempHist, state.humHist, state.pressAvgHist]) {
    while(arr.length>L) arr.shift();
  }

  // maintain per-sensor histories (for CSV richness)
  ensurePerSensorHist(state.last.P.length);
  for(let i=0;i<state.last.P.length;i++){
    state.pressHistAll[i].push(state.last.P[i]);
    while(state.pressHistAll[i].length> L) state.pressHistAll[i].shift();
  }

  updateUI();
}
function ensurePerSensorHist(n){
  while(state.pressHistAll.length< n) state.pressHistAll.push([]);
  // If sensors reduced, we keep arrays (CSV columns remain superset)
}

/* ------------------ UI Update ------------------ */
function updateUI(){
  // Cards
  if(state.last.T!=null){
    tempVal.textContent = state.last.T.toFixed(1) + ' Â°C';
    const cls = state.last.T>=cfg.thTemp ? 'bad' : 'ok';
    tempSub.innerHTML = `<span class="${cls}">Threshold ${cfg.thTemp.toFixed(1)}Â°C</span>`;
  }
  if(state.last.H!=null){
    humVal.textContent = state.last.H.toFixed(1) + ' %';
    humSub.textContent = 'Relative humidity';
  }
  const P = state.last.P||[];
  if(P.length){
    const avg = Math.round(P.reduce((a,b)=>a+b,0)/P.length);
    const maxP = Math.max(...P);
    const cls = (maxP>=cfg.thPress) ? 'bad' : (avg>=cfg.thPress*0.85 ? 'warn':'ok');
    pressVal.textContent = `${avg} avg`;
    pressSub.innerHTML = `<span class="${cls}">Max ${maxP} / Alert â‰¥ ${cfg.thPress}</span>`;
  } else {
    pressVal.textContent = '--';
    pressSub.textContent = 'No pressure sensors yet';
  }

  // Chips (names)
  chips.innerHTML = '';
  const names = getPressureNames(P.length);
  names.forEach((nm,i)=>{
    const v = P[i] ?? 'â€”';
    const alert = (typeof v==='number' && v>=cfg.thPress) ? 'bad' : '';
    const chip = document.createElement('span');
    chip.className = 'chip ' + alert;
    chip.title = `P${i+1}`;
    chip.textContent = `${nm}: ${v}`;
    chips.appendChild(chip);
  });

  // Charts
  tempChart.update(); humChart.update(); pressChart.update();

  // Heatmap
  drawHeatmap(P);

  // Alerts (non-blocking)
  if(state.last.T!=null && state.last.T>=cfg.thTemp){
    softToast(`High temperature: ${state.last.T.toFixed(1)}Â°C`);
  }
  if(P.some(v=>v>=cfg.thPress)){
    softToast(`High pressure hotspot detected`);
  }
}

/* ------------------ Soft Toast ------------------ */
let toastTimer=null;
function softToast(msg){
  if(toastTimer) return; // avoid spam
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.padding='10px 14px'; t.style.background='rgba(0,0,0,.75)'; t.style.color='#fff'; t.style.borderRadius='10px'; t.style.fontSize='.95rem'; t.style.zIndex=9999;
  t.textContent = msg;
  document.body.appendChild(t);
  toastTimer = setTimeout(()=>{ document.body.removeChild(t); toastTimer=null; }, 1800);
}

/* ------------------ BLE ------------------ */
let bleChar=null, bleDevice=null;

async function connectBLE(){
  try{
    const device = await navigator.bluetooth.requestDevice({
      filters:[{ services:[cfg.svcUuid] }]
    });
    bleDevice = device;
    devName.textContent = device.name||'ESP32';
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(cfg.svcUuid);
    bleChar = await service.getCharacteristic(cfg.chrUuid);
    await bleChar.startNotifications();
    bleChar.addEventListener('characteristicvaluechanged', handleNotification);
    setConnected(true);
  }catch(err){
    console.error(err);
    setConnected(false);
    softToast('BLE connection failed');
  }
}
function handleNotification(e){
  const raw = new TextDecoder().decode(e.target.value);
  const sample = parsePayload(raw);
  pushData(sample);
}
function setConnected(v){
  state.connected = v;
  connDot.classList.toggle('ok', v);
  connTxt.textContent = v ? 'Connected' : 'Disconnected';
}

/* ------------------ Settings ------------------ */
const dlg = el('settingsDlg');
function openSettings(){
  el('svcUuid').value = cfg.svcUuid;
  el('chrUuid').value = cfg.chrUuid;
  el('thTemp').value = cfg.thTemp;
  el('thPress').value = cfg.thPress;
  el('histLen').value = cfg.histLen;
  el('fmt').value = cfg.fmt;
  el('sensorNames').value = cfg.sensorNames.join(', ');
  el('notes').value = localStorage.getItem('notes')||'';
  dlg.showModal();
}
function saveSettings(){
  cfg.svcUuid = el('svcUuid').value.trim() || cfg.svcUuid;
  cfg.chrUuid = el('chrUuid').value.trim() || cfg.chrUuid;
  cfg.thTemp = parseFloat(el('thTemp').value)||cfg.thTemp;
  cfg.thPress = parseInt(el('thPress').value)||cfg.thPress;
  cfg.histLen = Math.max(30, parseInt(el('histLen').value)||cfg.histLen);
  cfg.fmt = el('fmt').value;
  cfg.sensorNames = el('sensorNames').value.split(',').map(s=>s.trim()).filter(Boolean);
  localStorage.setItem('notes', el('notes').value);
  saveCfg();
  dlg.close();
  softToast('Settings saved');
}
function resetDefaults(){
  cfg = {...DEFAULTS};
  saveCfg();
  dlg.close();
  applyTheme(cfg.theme);
  softToast('Settings reset');
}

/* ------------------ Theme ------------------ */
function applyTheme(theme){
  document.documentElement.classList.toggle('dark', theme==='dark');
  cfg.theme = theme;
  localStorage.setItem('theme', theme);
}

/* ------------------ CSV Export ------------------ */
function exportCSV(){
  const cols = ['timestamp','temperature','humidity','pressure_avg'];
  const maxSensors = state.pressHistAll.length;
  for(let i=0;i<maxSensors;i++){ cols.push(`P${i+1}`); }
  const rows = [];
  const L = state.labels.length;
  for(let i=0;i<L;i++){
    const r = [state.labels[i], nAt(state.tempHist,i), nAt(state.humHist,i), nAt(state.pressAvgHist,i)];
    for(let s=0;s<maxSensors;s++){
      r.push(nAt(state.pressHistAll[s], i));
    }
    rows.push(r);
  }
  const csv = [cols.join(',')].concat(rows.map(r=>r.join(','))).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `smart-sock-${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
  a.click();
}
function nAt(arr,i){ const v = arr[i]; return (v==null||Number.isNaN(v))? '' : v; }

/* ------------------ Helpers ------------------ */
function loadCfg(){
  const raw = localStorage.getItem('ss_cfg');
  if(!raw) return {...DEFAULTS};
  try{ const merged = {...DEFAULTS, ...JSON.parse(raw)}; return merged; }catch{ return {...DEFAULTS}; }
}
function saveCfg(){ localStorage.setItem('ss_cfg', JSON.stringify(cfg)); }
function getPressureNames(n){
  if(!cfg.sensorNames?.length) return Array.from({length:n},(_,i)=>`P${i+1}`);
  const out = [];
  for(let i=0;i<n;i++) out.push(cfg.sensorNames[i] || `P${i+1}`);
  return out;
}

/* ------------------ Wire up UI ------------------ */
el('connectBtn').addEventListener('click', connectBLE);
el('settingsBtn').addEventListener('click', openSettings);
el('closeSettings').addEventListener('click', ()=>dlg.close());
el('saveBtn').addEventListener('click', saveSettings);
el('resetBtn').addEventListener('click', resetDefaults);
el('themeBtn').addEventListener('click', ()=>applyTheme(cfg.theme==='dark'?'light':'dark'));
el('exportBtn').addEventListener('click', exportCSV);

/* ------------------ Initial ------------------ */
devName.textContent = 'â€”';
connTxt.textContent = 'Disconnected';
document.getElementById('ver').textContent = 'v1.0';
</script>
</body>
</html>
